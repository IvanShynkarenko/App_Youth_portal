// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  STUDENT
  MENTOR
  ADMIN
}

enum InternshipStatus {
  DRAFT
  PUBLISHED
  ARCHIVED
}

enum ApplicationStatus {
  SUBMITTED
  REVIEWED
  MENTOR_ASSIGNED
  IN_PROGRESS
  COMPLETED
  REJECTED
}

enum TaskType {
  LEARNING
  PRACTICAL
  REFLECTION
}

enum TaskProgressStatus {
  PENDING
  IN_PROGRESS
  SUBMITTED
  APPROVED
}

enum NotificationType {
  APPLICATION_STATUS_CHANGED
  FEEDBACK_RECEIVED
  DEADLINE_REMINDER
}

model User {
  id           String   @id @default(cuid())
  email        String   @unique
  passwordHash String
  name         String
  role         UserRole
  city         String?
  interests    String? // Comma-separated tags
  linkedinUrl  String?
  portfolioUrl String?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // Relations
  applicationsAsStudent Application[] @relation("StudentApplications")
  mentorAssignments    MentorAssignment[]
  feedbacks            Feedback[]
  notifications        Notification[]
  taskProgresses       TaskProgress[]
  createdInternships   MicroInternship[] @relation("InternshipOwner")

  @@index([email])
  @@index([role])
}

model MicroInternship {
  id             String            @id @default(cuid())
  title          String
  description    String
  durationInWeeks Int             // 3-6 weeks
  tags           String            // Comma-separated: "IT,Marketing,Design"
  status         InternshipStatus  @default(DRAFT)
  ownerId        String
  createdAt      DateTime          @default(now())
  updatedAt      DateTime          @updatedAt

  // Relations
  owner          User              @relation("InternshipOwner", fields: [ownerId], references: [id])
  applications   Application[]
  weeklyPlans    WeeklyPlan[]
  artifactTemplates ArtifactTemplate[]

  @@index([status])
  @@index([ownerId])
}

model Application {
  id                String            @id @default(cuid())
  studentId         String
  microInternshipId String
  motivation        String            // 3-5 bullet points
  interests         String?           // Additional interests
  city              String?
  linkedinUrl       String?
  portfolioUrl      String?
  status            ApplicationStatus @default(SUBMITTED)
  submittedAt       DateTime          @default(now())
  reviewedAt        DateTime?
  mentorAssignedAt  DateTime?
  startedAt         DateTime?
  completedAt       DateTime?
  rejectedAt        DateTime?
  rejectionReason   String?
  createdAt         DateTime          @default(now())
  updatedAt         DateTime          @updatedAt

  // Relations
  student           User              @relation("StudentApplications", fields: [studentId], references: [id])
  microInternship   MicroInternship   @relation(fields: [microInternshipId], references: [id])
  mentorAssignment  MentorAssignment?
  feedbacks         Feedback[]

  @@unique([studentId, microInternshipId])
  @@index([status])
  @@index([studentId])
  @@index([microInternshipId])
}

model MentorAssignment {
  id                String   @id @default(cuid())
  mentorId         String
  applicationId    String   @unique
  availabilitySlots Json?   // e.g., ["Tue 18:00-20:00", "Thu 17:00-19:00"]
  slaMode          String   @default("LIGHT") // "FULL" | "LIGHT"
  onTimeReplies    Int      @default(0)
  totalReplies     Int      @default(0)
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  // Relations
  mentor            User        @relation(fields: [mentorId], references: [id])
  application      Application  @relation(fields: [applicationId], references: [id])

  @@index([mentorId])
}

model WeeklyPlan {
  id                String   @id @default(cuid())
  microInternshipId String
  weekNumber        Int      // 1..N
  title             String
  description       String
  deadlineAt        DateTime?
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  // Relations
  microInternship   MicroInternship @relation(fields: [microInternshipId], references: [id])
  tasks             Task[]

  @@unique([microInternshipId, weekNumber])
  @@index([microInternshipId])
}

model Task {
  id                String   @id @default(cuid())
  weeklyPlanId      String
  title             String
  description       String
  type              TaskType
  artifactTemplateId String?
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  // Relations
  weeklyPlan        WeeklyPlan       @relation(fields: [weeklyPlanId], references: [id])
  artifactTemplate  ArtifactTemplate? @relation(fields: [artifactTemplateId], references: [id])
  taskProgresses    TaskProgress[]

  @@index([weeklyPlanId])
}

model TaskProgress {
  id          String            @id @default(cuid())
  taskId      String
  studentId   String
  status      TaskProgressStatus @default(PENDING)
  artifactUrl String?           // File URL or text content
  submittedAt DateTime?
  approvedAt  DateTime?
  createdAt   DateTime          @default(now())
  updatedAt   DateTime          @updatedAt

  // Relations
  task        Task              @relation(fields: [taskId], references: [id])
  student     User              @relation(fields: [studentId], references: [id])
  feedbacks   Feedback[]

  @@unique([taskId, studentId])
  @@index([studentId])
  @@index([status])
}

model ArtifactTemplate {
  id                String   @id @default(cuid())
  microInternshipId String?
  name              String
  description       String
  body              String   // Markdown/text with placeholders
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  // Relations
  microInternship   MicroInternship? @relation(fields: [microInternshipId], references: [id])
  tasks             Task[]

  @@index([microInternshipId])
}

model Feedback {
  id              String   @id @default(cuid())
  authorId        String
  applicationId   String?
  taskProgressId  String?
  text            String
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  author          User            @relation(fields: [authorId], references: [id])
  application     Application?    @relation(fields: [applicationId], references: [id])
  taskProgress    TaskProgress?   @relation(fields: [taskProgressId], references: [id])

  @@index([authorId])
  @@index([applicationId])
  @@index([taskProgressId])
}

model Notification {
  id        String           @id @default(cuid())
  userId    String
  type      NotificationType
  payload   Json             // Flexible JSON for different notification data
  read      Boolean          @default(false)
  createdAt DateTime         @default(now())

  // Relations
  user      User             @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([read])
}

model MetricSnapshot {
  id                        String   @id @default(cuid())
  date                      DateTime @default(now())
  completionRateApplications Float?  // % of applications that reached COMPLETED
  completionRateArtifacts   Float?  // % of students who submitted final artifact
  slaOnTime                 Float?  // % of mentor replies within 48h
  csatScore                 Float?  // Average CSAT (1-5)
  createdAt                 DateTime @default(now())

  @@index([date])
}

